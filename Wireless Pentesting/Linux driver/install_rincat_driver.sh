#!/bin/bash

# Exit if any command exits with a non-zero status code
set -e

REPO_URL="https://github.com/RinCat/RTL88x2BU-Linux-Driver.git"
CLONE_DIR="$HOME/Downloads/RTL88x2BU-Linux-Driver"

# Print error messages and exits
function handle_error {
    echo "Error occurred in script at line: $1"
    exit 1
}

# catch any error and call handle_error
trap 'handle_error $LINENO' ERR

# Check and install dependencies
echo "Checking and installing dependencies..."
sudo apt-get update
sudo apt-get install -y git build-essential dkms linux-headers-$(uname -r)

# Step 1: Clone the repository
echo "Cloning repository from $REPO_URL..."
if [ ! -d "$CLONE_DIR" ]; then
    git clone $REPO_URL $CLONE_DIR
else
    echo "Repository already cloned at $CLONE_DIR, updating..."
    cd $CLONE_DIR
    git pull
    cd -
fi

# Step 2: Move to the cloned directory
cd $CLONE_DIR

# Step 3: Get the package version (using a default if not found)
echo "Extracting version..."
VER=$(grep -oP '(?<=PACKAGE_VERSION=").*(?=")' dkms.conf 2>/dev/null || echo "1.0")

# Step 4: Copy driver source files to /usr/src for DKMS
echo "Copying driver source files to /usr/src/rtl88x2bu-${VER}..."
sudo rsync -rvhP ./ /usr/src/rtl88x2bu-${VER}

# Step 5: Add the driver to DKMS
echo "Adding driver to DKMS..."
sudo dkms add -m rtl88x2bu -v ${VER}

# Step 6: Build and install the driver
echo "Building and installing the driver with DKMS..."
sudo dkms install -m rtl88x2bu -v ${VER}

# Step 7: Load the driver into the kernel
echo "Loading the driver into the kernel..."
sudo modprobe 88x2bu

# Step 8: Blacklist conflicting drivers
echo "Blacklisting conflicting drivers..."
echo "blacklist rtw88_8822bu" | sudo tee -a /etc/modprobe.d/rtw88_8822bu.conf

# Step 9: Update initramfs
echo "Updating initramfs..."
sudo update-initramfs -u

# Step 10: Confirmation message
echo "Driver installation complete! Your wireless adapter should now be recognized."

# Step 11: Check DKMS status
dkms status

echo "Script finished successfully!"
echo "Reboot your system to ensure all changes take effect."
read -p "Do you want to reboot now? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]
then
    sudo reboot
fi